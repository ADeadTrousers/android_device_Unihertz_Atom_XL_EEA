From 5b810f3d5a09d092d4579d4d305482653169b63c Mon Sep 17 00:00:00 2001
From: Matthias Leitl <a.dead.trousers@gmail.com>
Date: Sun, 22 Nov 2020 16:28:45 +0100
Subject: [PATCH] build: add rule to include Magisk in builds

Change-Id: I958a6928c2da1e11417a71c1c31dceb6d496856b
---
 core/Makefile | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/core/Makefile b/core/Makefile
index a5eef489f..d73b54798 100644
--- a/core/Makefile
+++ b/core/Makefile
@@ -1903,6 +1903,9 @@ $(RECOVERY_INSTALL_OTA_KEYS): $(SOONG_ZIP) $(OTA_PUBLIC_KEYS) $(extra_keys)
 	$(hide) $(SOONG_ZIP) -o $@ $(foreach key_file, $(PRIVATE_OTA_PUBLIC_KEYS) $(extra_keys), -C $(dir $(key_file)) -f $(key_file))
 
 RECOVERYIMAGE_ID_FILE := $(PRODUCT_OUT)/recovery.id
+MAGISK_INIT := $(PRODUCT_OUT)/magiskinit
+ROOT_INIT := $(TARGET_ROOT_OUT)/init
+RECOVERY_ROOT_INIT := $(TARGET_RECOVERY_ROOT_OUT)/init
 
 define build-recoveryramdisk
   $(hide) mkdir -p $(TARGET_RECOVERY_OUT)
@@ -1912,7 +1915,9 @@ define build-recoveryramdisk
   $(hide) rsync -a --exclude=sdcard $(IGNORE_RECOVERY_SEPOLICY) $(IGNORE_CACHE_LINK) $(TARGET_ROOT_OUT) $(TARGET_RECOVERY_OUT)
   # Modifying ramdisk contents...
   $(if $(filter true,$(BOARD_BUILD_SYSTEM_ROOT_IMAGE)),, \
-    $(hide) ln -sf /system/bin/init $(TARGET_RECOVERY_ROOT_OUT)/init)
+    $(hide) ln -sf /system/bin/init $(RECOVERY_ROOT_INIT))
+  $(if $(filter true,$(BOARD_MAGISK_INIT)), \
+    $(hide) rsync -a $(MAGISK_INIT) $(RECOVERY_ROOT_INIT))
   $(if $(BOARD_RECOVERY_KERNEL_MODULES), \
     $(call build-image-kernel-modules,$(BOARD_RECOVERY_KERNEL_MODULES),$(TARGET_RECOVERY_ROOT_OUT),,$(call intermediates-dir-for,PACKAGING,depmod_recovery)))
   # Removes $(TARGET_RECOVERY_ROOT_OUT)/init*.rc EXCEPT init.recovery*.rc.
-- 
2.25.1

